{% extends "base.html" %}
{% block content %}
    <div>
        <h2>Ride: <code>{{ f.ride.name }}</code></h2>
        <table>
            <tbody>
            <tr>
                <td>Actions:</td>
                <td><a role="button" style="background-color: green; border-color: green;" @click="startApiHeartbeat()">Start</a>
                    <a style="background-color: red; border-color: red;" role="button" @click="stopApiHeartbeat()">Stop</button>
                </td>
            </tr>
            <tr>
                <td>Duration:</td>
                <td><code>{|{ makePrettyTime({{ f.ride.duration }}) }|}</code></td>
            </tr>
            <tr>
                <td @click="updateChart()">Completed:</td>
                <td><code>{|{ makePrettyTime(localCompleted) }|} ({|{ percentComplete }|}%)</code></td>
            </tr>
            </tbody>
        </table>
    </div>

    <div>
        <div class="chart-container" style="position: relative;">
            <canvas id="myChart"></canvas>
        </div>
    </div>


{% endblock %}
{% block page_script %}
    <script type="module">

        // imports
        import { makePrettyTime } from '{{ url_for('static', filename='index.js') }}';

        // set data
        var data = {
            localCompleted: {{ f.ride.completed }},
            heartbeatInterval: null,
            chartData:{
                labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                datasets: [{
                    label: '# of Votes',
                    data: [12, 19, 3, 5, 2, 3],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            chart:null
        }

        // create Vue
        var vm = new Vue({
            el: '#vm',
            data: data,
            delimiters: ['{|{', '}|}'],
            computed:{
                percentComplete(){
                    return Math.floor((this.localCompleted / {{ f.ride.duration }}) * 100);
                }
            },
            methods: {
                startApiHeartbeat: function () {
                    this.heartbeatInterval = setInterval(() => {

                        // increment completed
                        this.localCompleted += 1;

                        // get heartbeat
                        axios.post('/api/heartbeat', {"localRide": {"completed": this.localCompleted}})
                            .then(response => {
                                console.log(response.data)
                            })
                            .catch(error => console.error(error));
                    }, 1000);
                },
                stopApiHeartbeat() {
                    clearInterval(this.heartbeatInterval);
                },
                makePrettyTime(s) {
                    return makePrettyTime(s);
                },
                createChart(){
                    const ctx = document.getElementById('myChart').getContext('2d');
                    this.chart = new Chart(ctx, {
                        type: 'line',
                        data: this.chartData,
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            },
                            responsive:true
                        }
                    });
                },
                updateChart(){
                    this.chart.update();
                }
            },
            mounted: function () {
                // this.startApiHeartbeat();
                this.createChart();
            }
        })

    </script>
{% endblock %}